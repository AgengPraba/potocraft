<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pas Foto App</title>
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@3.8.0/dist/full.css"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cropper.js -->
    <link
      href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
  </head>
  <body class="bg-base-200">
    <div class="flex min-h-screen">
      <!-- Sidebar Navigasi -->
      <div class="w-48 bg-base-100 border-r p-4 space-y-2">
        <button class="btn w-full tab-btn tab-active" data-tab="upload">
          üì§ Upload
        </button>
        <button class="btn w-full tab-btn" data-tab="size">üìê Ukuran</button>
        <button class="btn w-full tab-btn" data-tab="crop">‚úÇÔ∏è Tanam</button>
        <button class="btn w-full tab-btn" data-tab="bg">
          üé® Latar Belakang
        </button>
        <button class="btn w-full tab-btn" data-tab="download">‚¨áÔ∏è Unduh</button>
      </div>

      <!-- Konten Tab -->
      <div class="flex-1 p-6 space-y-4">
        <!-- Upload -->
        <div id="tab-upload" class="tab-content">
          <h2 class="text-xl font-bold mb-2">Upload Foto</h2>
          <input
            type="file"
            id="photoInput"
            class="file-input file-input-bordered w-full max-w-sm"
          />
          <div class="mt-4"><img id="preview" class="max-w-xs border" /></div>
        </div>

        <!-- Size -->
        <div id="tab-size" class="tab-content hidden">
          <h2 class="text-xl font-bold mb-2">Pilih Ukuran</h2>
          <select id="photoSize" class="select select-bordered w-full max-w-xs">
            <option value="2x3">2x3</option>
            <option value="3x4">3x4</option>
            <option value="4x6">4x6</option>
          </select>
        </div>

        <!-- Crop -->
        <div id="tab-crop" class="tab-content hidden">
          <h2 class="text-xl font-bold mb-2">Tanam Foto</h2>
          <p class="mb-2">Gunakan mouse untuk crop sesuai rasio</p>
          <div>
            <img id="cropImage" class="max-w-sm border" />
            <div class="mt-2">
              <button class="btn btn-success" onclick="submitCropped()">
                ‚úÖ Simpan Crop
              </button>
            </div>
          </div>
        </div>

        <!-- Background -->
        <div id="tab-bg" class="tab-content hidden">
          <h2 class="text-xl font-bold mb-2">Latar Belakang</h2>
          <input type="color" id="bgColor" class="input input-bordered w-24" />
          <div class="flex gap-4 mt-4">
            <div>
              <p class="mb-1">Asli</p>
              <img id="original" class="w-48 border" />
            </div>
            <div>
              <p class="mb-1">Tanpa Background</p>
              <img id="noBg" class="w-48 border" />
            </div>
          </div>
          <button onclick="removeBackground()" class="btn btn-accent mt-4">
            Proses Hapus Background
          </button>
        </div>

        <!-- Download -->
        <div id="tab-download" class="tab-content hidden">
          <h2 class="text-xl font-bold mb-2">Unduh Hasil</h2>
          <a id="downloadBtn" class="btn btn-primary" href="#">‚¨áÔ∏è Unduh Foto</a>
        </div>
      </div>
    </div>

    <script>
      const tabs = document.querySelectorAll(".tab-btn");
      const contents = document.querySelectorAll(".tab-content");

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          const target = tab.getAttribute("data-tab");

          // Toggle active class
          tabs.forEach((t) => t.classList.remove("tab-active"));
          tab.classList.add("tab-active");

          // Show/hide content
          contents.forEach((content) => {
            content.classList.add("hidden");
          });
          document.getElementById(`tab-${target}`).classList.remove("hidden");
        });
      });

      // Preview upload
      document
        .getElementById("photoInput")
        .addEventListener("change", (event) => {
          const file = event.target.files[0];
          if (file) {
            const url = URL.createObjectURL(file);
            document.getElementById("preview").src = url;
            document.getElementById("original").src = url;
          }
        });

      // Hapus background
      async function removeBackground() {
        const fileInput = document.getElementById("photoInput");
        const file = fileInput.files[0];
        const bgColor = document.getElementById("bgColor").value;

        if (!file) return alert("Unggah foto terlebih dahulu.");

        const formData = new FormData();
        formData.append("photo", file);

        const uploadRes = await fetch("/upload", {
          method: "POST",
          body: formData,
        });

        const data = await uploadRes.json();
        const filename = data.filename;

        const removeRes = await fetch("/remove_bg", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ filename: filename, bgColor: bgColor }),
        });

        const result = await removeRes.json();
        document.getElementById("noBg").src = result.processed_path;
        document.getElementById("downloadBtn").href = "/download/" + filename;
      }

      let cropper;

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          const target = tab.getAttribute("data-tab");

          // Aktifkan cropper saat tab crop dibuka
          if (target === "crop") {
            const img = document.getElementById("preview");
            const cropImage = document.getElementById("cropImage");
            cropImage.src = img.src;

            cropImage.onload = () => {
              if (cropper) cropper.destroy();
              cropper = new Cropper(cropImage, {
                aspectRatio: 3 / 4, // Default 3x4, bisa diubah sesuai pilihan
                viewMode: 1,
              });
            };
          }
        });
      });

      // Kirim hasil crop ke backend
      function submitCropped() {
        if (!cropper) return;

        cropper.getCroppedCanvas().toBlob((blob) => {
          const formData = new FormData();
          formData.append("cropped", blob);

          fetch("/crop", {
            method: "POST",
            body: formData,
          })
            .then((res) => res.json())
            .then((data) => {
              document.getElementById("noBg").src = data.cropped_path;
              document.getElementById("downloadBtn").href =
                "/download/" + data.filename;
              alert("Crop disimpan!");
            });
        }, "image/png");
      }
    </script>
  </body>
</html>
